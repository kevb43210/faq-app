<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FAQ Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --radius:16px; --pad:16px; }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0; color: #0f172a; background: #f8fafc;
    }
    header {
      position: sticky; top: 0; z-index: 10;
      background: #ffffffcc; backdrop-filter: blur(8px);
      border-bottom: 1px solid #e2e8f0;
    }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 18px var(--pad); }
    h1 { margin: 0 0 8px; font-size: 22px; }
    .controls { display: grid; gap: 10px; grid-template-columns: 1fr; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .search {
      flex:1; display:flex; align-items:center; gap:8px;
      background: #fff; border:1px solid #cbd5e1; border-radius: var(--radius);
      padding: 10px 12px;
    }
    .search input {
      border:0; outline:0; flex:1; font-size: 16px; background: transparent;
    }
    .chips { display:flex; gap:8px; flex-wrap:wrap; }
    .chip {
      display:inline-flex; align-items:center; gap:6px;
      background:#e2e8f0; padding:6px 10px; border-radius:999px; font-size: 13px;
      cursor: pointer; user-select:none;
    }
    .chip input { accent-color: #0ea5e9; }
    .meta { font-size: 13px; color:#475569; }
    .btn {
      padding:8px 12px; border-radius:10px; border:1px solid #94a3b8;
      background:#fff; cursor:pointer;
    }
    main { padding: 14px var(--pad) 40px; }
    .grid { display:grid; gap:12px; }
    .card {
      background:#fff; border:1px solid #e2e8f0; border-radius: var(--radius);
      padding: 14px; box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .card h3 { margin:0 0 6px; font-size:18px; }
    .pill { display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; background:#eff6ff; border:1px solid #bfdbfe; color:#1e3a8a; }
    .tags { font-size:12px; color:#475569; margin-top:6px; }
    mark { padding:0 2px; border-radius:4px; background:#fff3bf; }
    .muted { color:#64748b; font-size:12px; }
    footer { padding: 24px var(--pad); color:#64748b; }
    @media (min-width: 800px) { .grid { grid-template-columns: 1fr 1fr; } }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Knowledge Base Search</h1>
      <div class="controls">
        <div class="row">
          <label class="search" aria-label="Search FAQs">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 0 0 1.57-4.23A6.5 6.5 0 1 0 9.5 16a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l5 5l1.5-1.5l-5-5zm-6 0A4.5 4.5 0 1 1 14 9.5A4.505 4.505 0 0 1 9.5 14"></path>
            </svg>
            <input id="q" type="search" placeholder="Search by keyword…" autocomplete="off" />
          </label>
          <button id="reset" class="btn" title="Clear search and filters">Reset</button>
        </div>
        <div id="categories" class="chips" aria-label="Category filters"></div>
        <div class="meta"><span id="count">0</span> results</div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="results" class="grid" role="list"></div>
  </main>

  <footer class="wrap muted">
    <div>Tip: Use quotes for exact phrases. Share your current view with the URL.</div>
  </footer>

<script>
  // --- Utilities ---
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const params = new URLSearchParams(location.search);

  function debounce(fn, ms=200){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms);}; }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
  function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
  function tokenize(q){
    // handle "exact phrases" and words
    const parts = [];
    q.replace(/"([^"]+)"|(\S+)/g, (_, p1, p2) => parts.push((p1||p2).trim()));
    return parts;
  }

  // Simple scoring: title hit > tags hit > answer hit
  function scoreItem(item, terms){
    if (!terms.length) return 0;
    const T = (s) => (s||"").toLowerCase();
    const title = T(item.title), ans = T(item.answer), tags = (item.tags||[]).map(T);
    let score = 0;
    for (const t of terms){
      const exact = t.startsWith('"') && t.endsWith('"') ? t.slice(1,-1) : t;
      const term = exact.toLowerCase();
      if (title.includes(term)) score += 3;
      if (tags.some(tag => tag.includes(term))) score += 2;
      if (ans.includes(term)) score += 1;
    }
    return score;
  }

  function highlight(text, query){
    if (!query.trim()) return escapeHtml(text);
    const tokens = tokenize(query).map(t => t.replace(/^"|"$/g,'')).filter(Boolean).map(escapeRegExp);
    if (!tokens.length) return escapeHtml(text);
    const re = new RegExp("(" + tokens.join("|") + ")", "ig");
    return escapeHtml(text).replace(re, "<mark>$1</mark>");
  }

  // --- App state ---
  let DATA = [];
  let CATS = []; // all categories
  let selectedCats = new Set();

  // --- Renderers ---
  function renderCategories(){
    const el = $("#categories");
    el.innerHTML = "";
    CATS.forEach(cat => {
      const id = `cat-${cat.toLowerCase().replace(/[^a-z0-9]+/g,'-')}`;
      const wrapper = document.createElement("label");
      wrapper.className = "chip";
      wrapper.innerHTML = `
        <input type="checkbox" id="${id}" value="${escapeHtml(cat)}" ${selectedCats.has(cat) ? "checked":""}/>
        <span>${escapeHtml(cat)}</span>
      `;
      wrapper.querySelector("input").addEventListener("change", e => {
        if (e.target.checked) selectedCats.add(cat); else selectedCats.delete(cat);
        update();
      });
      el.appendChild(wrapper);
    });
  }

  function renderResults(items, q){
    const res = $("#results");
    res.innerHTML = "";
    if (!items.length){
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.textContent = "No results. Try different keywords or remove filters.";
      res.appendChild(empty);
      return;
    }

    for (const item of items){
      const card = document.createElement("article");
      card.className = "card";
      card.setAttribute("role","listitem");
      const cat = item.category || "Uncategorized";
      const tags = (item.tags||[]).join(", ");
      card.innerHTML = `
        <h3>${highlight(item.title || "Untitled", q)}</h3>
        <div class="pill" title="Category">${escapeHtml(cat)}</div>
        <div class="answer" style="margin-top:8px; line-height:1.45">${highlight(item.answer || "", q)}</div>
        <div class="tags">${tags ? "Tags: " + escapeHtml(tags) : ""}</div>
        <div class="muted" style="margin-top:6px">
          ${item.lastUpdated ? "Updated: " + escapeHtml(item.lastUpdated) : ""}
          ${item.source ? ` · <a href="${encodeURI(item.source)}" target="_blank" rel="noopener">Source</a>` : ""}
        </div>
      `;
      res.appendChild(card);
    }
  }

  function applyFilters(){
    const q = ($("#q").value || "").trim();
    const terms = tokenize(q);
    const cats = selectedCats.size ? new Set([...selectedCats]) : null;

    let items = DATA.filter(item => {
      const catOK = !cats || cats.has(item.category || "Uncategorized");
      if (!catOK) return false;
      if (!terms.length) return true;
      const s = scoreItem(item, terms);
      return s > 0;
    });

    if (terms.length){
      items = items
        .map(i => ({...i, _score: scoreItem(i, terms)}))
        .sort((a,b) => b._score - a._score || a.title.localeCompare(b.title));
    } else {
      items = items.sort((a,b) => (b.lastUpdated||"").localeCompare(a.lastUpdated||"") || a.title.localeCompare(b.title));
    }
    return { items, q };
  }

  function syncUrl(){
    const q = ($("#q").value || "").trim();
    const cats = [...selectedCats].join(",");
    const p = new URLSearchParams();
    if (q) p.set("q", q);
    if (cats) p.set("cats", cats);
    const newUrl = location.pathname + (p.toString() ? "?" + p.toString() : "");
    history.replaceState(null, "", newUrl);
  }

  const update = debounce(() => {
    const { items, q } = applyFilters();
    $("#count").textContent = String(items.length);
    renderResults(items, q);
    syncUrl();
  }, 60);

  // --- Init ---
  async function init(){
    const resp = await fetch("./data.json");
    DATA = await resp.json();

    // normalize categories and collect unique set
    const set = new Set();
    DATA = DATA.map((r, i) => {
      const cat = r.category || "Uncategorized";
      set.add(cat);
      return {
        id: r.id || `faq-${i+1}`,
        title: r.title || "",
        category: cat,
        tags: Array.isArray(r.tags) ? r.tags : String(r.tags||"").split(",").map(s=>s.trim()).filter(Boolean),
        answer: r.answer || "",
        lastUpdated: r.lastUpdated || "",
        source: r.source || ""
      };
    });
    CATS = [...set].sort((a,b)=>a.localeCompare(b));
    renderCategories();

    // read initial URL state
    const q0 = params.get("q") || "";
    const cats0 = (params.get("cats") || "").split(",").filter(Boolean);
    $("#q").value = q0;
    cats0.forEach(c => selectedCats.add(c));
    // reflect URL-selected categories
    $$("#categories input[type=checkbox]").forEach(cb => {
      if (selectedCats.has(cb.value)) cb.checked = true;
    });

    $("#q").addEventListener("input", update);
    $("#reset").addEventListener("click", () => {
      $("#q").value = "";
      selectedCats.clear();
      $$("#categories input[type=checkbox]").forEach(cb => cb.checked = false);
      update();
    });

    update();
  }

  init();
</script>
</body>
</html>
